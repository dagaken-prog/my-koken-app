# **成年後見業務支援システム 運用・開発マニュアル**

## **1\. 運用編（日々の業務）**

### **1.1 アクセス方法**

* **URL:** https://my-kouken-app.streamlit.app (ブックマーク推奨)  
* **ログイン:** 設定されたパスワードを入力します。

### **1.2 基本操作**

* **活動記録:**  
  * 「利用者情報・活動記録」メニューから対象者を選択します。  
  * 「活動記録」フォームに入力し、「登録」を押します。  
  * 過去の記録は下部のリストに表示され、タップすると詳細確認・編集・削除が可能です。  
* **関係者への連絡:**  
  * 「利用者情報・活動記録」画面の基本情報欄、または「関係者・連絡先」メニューから、電話番号リンクをタップして発信できます。  
* **帳票出力:**  
  * 「帳票作成」メニューで、{{氏名}} などのタグを入れたExcelファイルをアップロードすると、データが埋め込まれた状態でダウンロードできます。

### **1.3 データのバックアップ**

* 定期的に「データ管理・移行」メニューから、各データの「CSVエクスポート」を行ってください。  
* ダウンロードしたCSVファイルは、万が一の際の復元（インポート）に使用できます。

## **2\. 開発編（機能修正・環境構築）**

システムを修正したり、新しいパソコンで開発を始める際の手順です。

### **2.1 新しい端末でのセットアップ手順（初回のみ）**

職場のPCなど、初めて開発を行う端末での準備です。

1. **ソフトのインストール:**  
   * **Python:** [公式サイト](https://www.python.org/downloads/) (※Install時に "Add python.exe to PATH" をチェック)  
   * **VS Code:** [公式サイト](https://code.visualstudio.com/)  
   * **Git:** [公式サイト](https://gitforwindows.org/)  
2. **フォルダの準備:**  
   * デスクトップ等に kouken\_system フォルダを作成します。  
   * メインPCから以下のファイルをコピーして配置します。  
     * .streamlit フォルダ (中に secrets.toml が入っていること)  
       * **重要:** secrets.toml には Supabase の接続情報 (url, key) が必要です。  
     * start\_cloud\_app.bat (起動用)  
     * 2\_update\_cloud.bat (更新用)  
     * 0\_sync\_download.bat (同期用)  
     * 0\_force\_sync.bat (強制同期用)  
     * requirements.txt (部品リスト)  
     * modules フォルダ (プログラムの機能部品が入っています)
3. **初期設定:**  
   * フォルダ内で 0\_sync\_download.bat を実行し、GitHubから最新コードを取得します。  
   * （初回のみ）フォルダでターミナルを開き、pip install \-r requirements.txt を実行してライブラリをインストールします。

### **2.2 日々の修正・開発フロー**

**【鉄則】作業前はダウンロード、作業後はアップロード**

1. **作業開始 (Pull):**  
   * 0\_sync\_download.bat を実行し、最新の状態にします。  
   * ※エラーが出た場合は 0\_force\_sync.bat で強制的にクラウドの状態に合わせます。  
2. **編集:**  
   * VS Code で編集します。  
     * **画面や全体の流れ:** `app_deploy.py` や `modules/ui.py`  
     * **データベース処理:** `modules/database.py`  
     * **計算や変換:** `modules/utils.py`  
3. **動作確認:**  
   * start\_cloud\_app.bat を実行し、ブラウザで動作を確認します。  
   * Supabaseに接続するため、本番データが表示されます（取り扱いに注意）。  
4. **作業終了 (Push):**  
   * 2\_update\_cloud.bat を実行し、修正内容をGitHubへ送信します。  
   * 数秒〜数十秒で、スマホ等の本番環境にも反映されます。

## **3\. トラブルシューティング**

### **Q. スマホでデータが表示されない**

* Supabaseへの通信エラーの可能性があります。少し待って再読み込みしてください。  
* それでも直らない場合、Streamlit Cloudの管理画面で「Reboot app」を試してください。

### **Q. エラー ModuleNotFoundError が出る**

* **必要なライブラリがない場合:** `pip install -r requirements.txt` を実行してください。
* **'modules' が見つからない場合:** `app_deploy.py` と同じ階層に `modules` フォルダがあるか確認してください。

### **Q. エラー Secretsが見つかりません が出る**

* **ローカルの場合:** .streamlit/secrets.toml ファイルが存在し、正しい情報が書かれているか確認してください。  
* **クラウドの場合:** Streamlit Community Cloud の Settings \> Secrets に、tomlの内容が貼り付けられているか確認してください。

### **Q. 活動履歴が表示されない・検索できない**

* IDの型不一致の可能性があります。プログラム内の to\_safe\_id 関数などが正しく機能しているか確認が必要ですが、現在のバージョン(v1.0以降)では対策済みです。